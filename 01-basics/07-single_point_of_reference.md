---
marp: true
theme: katas
---
<!--
size: 16:9
paginate: true
-->
<!-- header: 勉強会#-->

# 参照の一点性

_Single point of reference_

>>> 注:「定義の一点性(_Single Point of Definition_)」「単一代入」とも言う。

---

## 参照の一点性$^1$

変数を一度定義したら値を書き換えない。

```py
x = 193
 :
x = 4649 # NG.値を途中で書き換えない
 :
```
↓
```py
x = 193
 : # xは通用範囲(スコープ)内で常に193
y = 4649 # 別の値には別の変数を用意する
 :
```

⇒ 値が変化することを考えなくて済む、見通しの良いコードになる。

---

## メリット：副作用がなくなる

**副作用とは**： 処理の呼び出しによってモジュールやクラスの状態が変化すること。呼ぶ前と呼んだ後とで得られる結果が変化する(かもしれない)

* 副作用のある処理がたくさんあると何が起きるか
    * 起動してからしばらくすると処理がおかしくなる
        * 途中でグローバル変数の値を書き換えていた
    * 処理結果がときどきおかしな計算結果を返す
        * 結果を参照する前に別タスクで処理が走っていた

→ **変数に値を再代入しないようにする**

<!-- 少し遠いところの話になるけれど、並行処理(マルチタスク/マルチスレッド)で安全なプログラムが書けるようになる -->

---

## おとしどころ…

…とはいえ、真面目に単一代入だけで作ろうとするのは関数型プログラミングの技法が必要になるなど大変。ループも再帰で書かないといけなくなる。

```py
# nの階乗をループで書く
def f(n):
  x = 1
  for i in range(n):
    x *= (i+1)
  return x
```
```py
# nの階乗を単一代入で書く
def factorial(n):
　if n < 2:
    return 1
　return n * factorial(n - 1)
```

---
## 目安

### 変数の定義だけで単一代入を扱う

* ループは別腹

### 再代入を行う処理と行わない処理とを分離する

* 再代入を行うmutableな処理と行わないimmutableな処理とを分けて書くと良い
    * 問題が起きたときはmutableの処理から調べれば良くなる

<!-- 言葉として定義と代入とを分けて考えると良いかも。 -->

---

## (参考)参照透過性を持つ関数

２つの特性を持つ関数のこと

1. 呼び出しの結果が、引数のみに依存する
    * 処理が冪(べき)等であり、何回呼んでも同じ結果を返す
    * 内部で他のメンバー変数などの状態を参照していない
2. 呼び出しが、他機能の動作に影響を与えない
    * 関数が副作用を持っていない

テストが非常に楽になり、再利用性も高まる。
